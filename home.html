<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Stlite app</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/browser@0.80.1/build/style.css" />
</head>

<body>
    <div id="root"></div>
    <script type="module">
        import { mount } from "https://cdn.jsdelivr.net/npm/@stlite/browser@0.80.1/build/stlite.js"
        mount(
            {
                requirements: ["requests"],
                entrypoint: "streamlit_app.py",
                files: {
                    "streamlit_app.py": `# Modified Streamlit App
import streamlit as st
import requests
import pandas as pd

# Public API endpoint - replace with your backend URL
API_BASE = "https://snowflake-insurance-ml-pipe.vercel.app/"

# Small intro
st.title("Insurance ML Pipeline")
st.write("This Streamlit app allows the user to view various aspects of the ML pipeline built for the insurance dataset.")

# Fetch data from backend
@st.cache_data
def get_gold_data():
    response = requests.get(f"{API_BASE}/api/gold_data")
    return pd.DataFrame(response.json())

gold_df = get_gold_data()

# Create scatterplot
st.subheader('Scatterplot of Predicted vs Actual Charges')
st.scatter_chart(gold_df, x='PREDICTED_CHARGES', y='CHARGES')

# Prediction function
def predict(data):
    response = requests.post(
        f"{API_BASE}/api/predict",
        json=data.to_dict(orient='records')[0]
    )
    return response.json()['prediction']

# User input form
st.subheader('User Input Form')
with st.form("user_input_form"):
    st.write("Select a value for each dimension to see what the model would predict")
    st.write("When submitted, these values run through the preprocessing and prediction pipeline \\
             that is saved in Snowflake's Model Registy ")

    # Age
    age = st.slider("Age", 0, 100, 40)

    # Gender
    gender = st.selectbox('Gender', ['Male','Female'])

    # BMI
    bmi = st.slider("BMI", 10, 55, 34)

    # Children
    children = st.slider("Children", 0, 10, 2)

    # Smoker
    smoker = st.selectbox('Smoker', options=['No', 'Yes'])

    # Region
    options = ['Northwest', 'Northeast', 'Southwest', 'Southeast']
    region = st.selectbox('Region', options)

    # Medical history
    medical_options= ['None','Heart Disease','Diabetes','High Blood Pressure']
    medical_history = st.selectbox("Medical History", medical_options).replace(" ", "_")

    # Family medical history
    family_medical_history = st.selectbox("Family Medical History", medical_options).replace(" ", "_")


    # Exercise frequency
    exercise_frequency = st.selectbox("Exercise Frequency", ['Never','Rarely','Occasionally','Frequently'])

    # Occupation
    occupation = st.selectbox("Occupation", ['Blue Collar','White Collar','Student', 'Unemployed']).replace(" ", "_")

    # Coverage level
    coverage_level = st.selectbox("Coverage Level", ['Basic','Standard','Premium'])
    
    # Every form must have a submit button.
    submitted = st.form_submit_button("Submit")



    if submitted:
        # create a dataframe with the user inputs
        user_input = pd.DataFrame({
            'AGE': [age],
            'GENDER': [gender.upper()],
            'BMI': [bmi],
            'CHILDREN': [children],
            'SMOKER': [smoker.upper()],
            'REGION': [region.upper()],
            'MEDICAL_HISTORY': [medical_history.upper()],
            'FAMILY_MEDICAL_HISTORY': [family_medical_history.upper()],
            'EXERCISE_FREQUENCY': [exercise_frequency.upper()],
            'OCCUPATION': [occupation.upper()],
            'COVERAGE_LEVEL': [coverage_level.upper()]
        })

        st.write(user_input)
        # put in a spinner while the predict is happening
        with st.spinner('Predicting...'):
            prediction = predict(user_input)
            st.write(f"Predicted Charges: ${prediction}")
`,

                },
            },
            document.getElementById("root")
        )

    </script>
</body>

</html>